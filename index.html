<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能数据匹配工具 - 专业匹配 & 院校匹配</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f8faff 0%, #e6f3ff 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 0 20px 0;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            color: #64748b;
            font-weight: 400;
        }

        /* 功能切换标签页 */
        .function-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 6px;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(79, 172, 254, 0.1);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-button {
            flex: 1;
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: rgba(79, 172, 254, 0.1);
            color: #4facfe;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .tab-icon {
            font-size: 1.2rem;
        }

        /* 功能说明区域 */
        .info-section {
            margin-bottom: 32px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            margin-bottom: 20px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(79, 172, 254, 0.06);
            border: 1px solid rgba(79, 172, 254, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(79, 172, 254, 0.12);
        }

        .info-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .info-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        .info-icon.overview { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .info-icon.matching { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .info-icon.validation { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .info-icon.upload { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .info-icon.result { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

        .info-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .info-card-content {
            color: #4a5568;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .rule-list {
            list-style: none;
            padding: 0;
            margin: 12px 0 0 0;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .rule-priority {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .priority-1 { background: #22c55e; }
        .priority-2 { background: #3b82f6; }
        .priority-3 { background: #f59e0b; }
        .priority-4 { background: #ef4444; }
        .priority-5 { background: #8b5cf6; }

        .rule-text {
            flex: 1;
        }

        .validation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .validation-item {
            background: #f1f5f9;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }

        .validation-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .validation-desc {
            color: #64748b;
            font-size: 0.75rem;
            line-height: 1.4;
        }

        .expand-toggle {
            background: none;
            border: none;
            color: #4facfe;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s ease;
        }

        .expand-toggle:hover {
            color: #2563eb;
        }

        .expand-icon {
            transition: transform 0.2s ease;
        }

        .expand-toggle.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 500px;
        }

        /* 隐藏内容容器 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(79, 172, 254, 0.08);
            padding: 48px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(79, 172, 254, 0.1);
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 48px;
        }

        .upload-box {
            border: 2px dashed #a7d8f0;
            border-radius: 20px;
            padding: 48px 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: linear-gradient(145deg, #ffffff 0%, #f8fcff 100%);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.05);
        }

        .upload-box:hover {
            border-color: #4facfe;
            background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79, 172, 254, 0.12);
        }

        .upload-box.dragover {
            border-color: #4facfe;
            background: linear-gradient(145deg, #e0f2fe 0%, #bae6fd 100%);
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(79, 172, 254, 0.18);
        }

        .upload-box h3 {
            color: #475569;
            margin-bottom: 16px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .upload-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            display: block;
        }

        .upload-text {
            color: #64748b;
            margin-bottom: 24px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.25);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.35);
        }

        .file-info {
            margin-top: 20px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            color: #166534;
            font-size: 0.9rem;
            display: none;
            border-left: 4px solid #22c55e;
        }

        .control-section {
            text-align: center;
            margin-bottom: 48px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .process-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25);
        }

        .process-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.35);
        }

        .process-btn:disabled {
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .export-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 220px;
            display: none;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25);
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.35);
        }

        .status {
            margin: 24px 0;
            padding: 16px 24px;
            border-radius: 12px;
            text-align: center;
            font-weight: 500;
            display: none;
            font-size: 0.95rem;
        }

        .status.processing {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .status.success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border-left: 4px solid #22c55e;
        }

        .status.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }

        .statistics-section {
            display: none;
            margin-bottom: 32px;
        }

        .total-count-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            padding: 16px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .total-count-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 4px;
        }

        .total-count-label {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .match-stats-section {
            margin-bottom: 20px;
        }

        .match-stats-title, .format-stats-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            padding-left: 8px;
            border-left: 4px solid #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .stat-success .stat-number { color: #22c55e; }
        .stat-warning .stat-number { color: #f59e0b; }
        .stat-error .stat-number { color: #ef4444; }
        .stat-info .stat-number { color: #3b82f6; }
        .stat-level1 .stat-number { color: #22c55e; }
        .stat-level2 .stat-number { color: #10b981; }
        .stat-level3 .stat-number { color: #f59e0b; }
        .stat-level4 .stat-number { color: #ef4444; }
        .stat-nomatch .stat-number { color: #6b7280; }

        /* v2.0新增：质量控制统计样式 */
        .stat-review .stat-number { color: #f59e0b; }
        .stat-failed .stat-number { color: #ef4444; }
        .stat-path .stat-number { color: #6366f1; }

        .stat-percent {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .results-section {
            margin-top: 40px;
            display: none;
        }

        .results-header {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-header h3 {
            color: #2d3748;
            font-size: 1.5rem;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .legend {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #475569;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 6px;
        }

        .legend-success { background: #22c55e; }
        .legend-warning { background: #f59e0b; }
        .legend-error { background: #ef4444; }
        .legend-level1 { background: #22c55e; }
        .legend-level2 { background: #10b981; }
        .legend-level3 { background: #f59e0b; }
        .legend-level4 { background: #ef4444; }
        .legend-nomatch { background: #6b7280; }

        /* v2.0新增：质量控制图例样式 */
        .legend-review { background: #f59e0b; }
        .legend-failed { background: #ef4444; }
        .legend-chinese { background: #3b82f6; }
        .legend-english { background: #10b981; }

        .table-wrapper {
            height: 600px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .table-container {
            height: 100%;
            overflow: auto;
            position: relative;
        }

        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
            min-width: 1200px;
        }

        .results-table th {
            background: #e0f2fe;
            color: #0369a1;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.8rem;
            border-bottom: 2px solid #bae6fd;
        }

        .results-table th.frozen {
            position: sticky;
            z-index: 20;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }

        .results-table th.frozen-1 { left: 0; }
        .results-table th.frozen-2 { left: 120px; }
        .results-table th.frozen-3 { left: 240px; }

        .results-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            height: 48px;
            max-height: 48px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }

        .results-table td.frozen {
            position: sticky;
            background: white;
            z-index: 15;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }

        .results-table td.frozen-1 { left: 0; width: 120px; }
        .results-table td.frozen-2 { left: 120px; width: 120px; }
        .results-table td.frozen-3 { left: 240px; width: 180px; }

        .results-table tbody tr:hover {
            background: #f8fafc;
        }

        .results-table tbody tr:hover td.frozen {
            background: #f8fafc;
        }

        .row-success { background: #f0fdf4 !important; }
        .row-warning { background: #fefce8 !important; }
        .row-error { background: #fef2f2 !important; }
        .row-level1 { background: #f0fdf4 !important; }
        .row-level2 { background: #ecfdf5 !important; }
        .row-level3 { background: #fefce8 !important; }
        .row-level4 { background: #fef2f2 !important; }
        .row-nomatch { background: #f9fafb !important; }

        .row-success td.frozen { background: #f0fdf4 !important; }
        .row-warning td.frozen { background: #fefce8 !important; }
        .row-error td.frozen { background: #fef2f2 !important; }
        .row-level1 td.frozen { background: #f0fdf4 !important; }
        .row-level2 td.frozen { background: #ecfdf5 !important; }
        .row-level3 td.frozen { background: #fefce8 !important; }
        .row-level4 td.frozen { background: #fef2f2 !important; }
        .row-nomatch td.frozen { background: #f9fafb !important; }

        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .confidence-high {
            background: #dcfce7;
            color: #166534;
        }

        .confidence-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-low {
            background: #fee2e2;
            color: #991b1b;
        }

        /* v2.0新增：状态徽章样式 */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
        }

        .status-badge.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-badge.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* v2.0新增：匹配路径徽章样式 */
        .path-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            text-align: center;
        }

        .path-badge.chinese {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }

        .path-badge.english {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .path-badge.mixed {
            background: #faf5ff;
            color: #7c3aed;
            border: 1px solid #d8b4fe;
        }

        /* v2.0新增：处理建议列样式 */
        .action-cell {
            font-size: 0.8rem;
            color: #666;
            max-width: 120px;
            word-wrap: break-word;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .validation-fixed {
            color: #f59e0b;
            font-weight: 500;
        }

        .validation-issue {
            color: #ef4444;
            font-weight: 500;
        }

        .validation-fixed {
            color: #166534;
            font-size: 0.8rem;
            background: #dcfce7;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        @media (max-width: 1024px) {
            .info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .validation-grid {
                grid-template-columns: 1fr;
            }

            .upload-section {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .function-tabs {
                max-width: 100%;
                margin: 0 20px 40px 20px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .main-card {
                padding: 24px;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }

            .process-btn, .export-btn {
                width: 100%;
                max-width: 300px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .total-count-card {
                padding: 24px;
            }
            
            .total-count-number {
                font-size: 2.5rem;
            }

            .legend {
                justify-content: center;
            }

            .table-wrapper {
                height: 400px;
            }

            .tab-button {
                padding: 12px 16px;
                font-size: 0.9rem;
            }

            .function-tabs {
                margin: 0 10px 30px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 智能数据匹配工具</h1>
            <p>专业数据匹配校验 & 中国院校智能匹配</p>
        </div>

        <!-- 功能切换标签页 -->
        <div class="function-tabs">
            <button class="tab-button active" onclick="switchTab('major')" id="majorTab">
                <span class="tab-icon">🎓</span>
                <span>专业匹配校验</span>
            </button>
            <button class="tab-button" onclick="switchTab('university')" id="universityTab">
                <span class="tab-icon">🏫</span>
                <span>中国院校匹配</span>
            </button>
        </div>

        <!-- 专业匹配内容 -->
        <div id="majorContent" class="tab-content active">
            <!-- 功能说明区域 - 专业匹配 -->
            <div class="info-section">
                <div class="info-grid">
                    <!-- 系统功能概述 -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-icon overview">📊</div>
                            <h3 class="info-card-title">系统功能概述</h3>
                        </div>
                        <div class="info-card-content">
                            <p>专业数据智能匹配与格式校验工具，支持Excel文件批量处理，提供4级渐进式匹配算法和智能格式修正功能。</p>
                            <button class="expand-toggle" onclick="toggleSection('overview')">
                                查看详细功能 <span class="expand-icon">▼</span>
                            </button>
                            <div class="collapsible-content" id="overview-content">
                                <ul class="rule-list">
                                    <li class="rule-item">✓ 支持Excel文件拖拽上传和批量处理</li>
                                    <li class="rule-item">✓ 智能数据匹配，自动绑定专业ID</li>
                                    <li class="rule-item">✓ 格式校验与自动修正功能</li>
                                    <li class="rule-item">✓ 实时统计和可视化结果展示</li>
                                    <li class="rule-item">✓ 一键导出处理结果到Excel</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 匹配规则说明 -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-icon matching">🎯</div>
                            <h3 class="info-card-title">4级匹配规则</h3>
                        </div>
                        <div class="info-card-content">
                            <p>采用4级渐进式匹配策略，优先级从高到低，确保数据匹配的准确性和完整性。</p>
                            <button class="expand-toggle" onclick="toggleSection('matching')">
                                查看匹配规则 <span class="expand-icon">▼</span>
                            </button>
                            <div class="collapsible-content" id="matching-content">
                                <ul class="rule-list">
                                    <li class="rule-item">
                                        <span class="rule-priority priority-1">1</span>
                                        <div class="rule-text"><strong>专业链接精确匹配</strong><br>标准化URL完全相同，最可靠的唯一标识</div>
                                    </li>
                                    <li class="rule-item">
                                        <span class="rule-priority priority-2">2</span>
                                        <div class="rule-text"><strong>课程编码精确匹配</strong><br>课程编码不为空且完全相同</div>
                                    </li>
                                    <li class="rule-item">
                                        <span class="rule-priority priority-3">3</span>
                                        <div class="rule-text"><strong>英文名+学位名称精确匹配</strong><br>智能组合后精确比对，核心匹配规则</div>
                                    </li>
                                    <li class="rule-item">
                                        <span class="rule-priority priority-4">4</span>
                                        <div class="rule-text"><strong>英文名+学位名称模糊匹配</strong><br>相似度>95%，结果标记"建议复核"</div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 校验规则说明 -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-icon validation">🔧</div>
                            <h3 class="info-card-title">格式校验规则</h3>
                        </div>
                        <div class="info-card-content">
                            <p>智能检测和修正数据格式问题，支持学制、开学时间、申请费用等关键字段的自动标准化。</p>
                            <button class="expand-toggle" onclick="toggleSection('validation')">
                                查看校验规则 <span class="expand-icon">▼</span>
                            </button>
                            <div class="collapsible-content" id="validation-content">
                                <div class="validation-grid">
                                    <div class="validation-item">
                                        <div class="validation-title">学制格式</div>
                                        <div class="validation-desc">标准：数字/单位<br>如：2/年, 1.5/年<br>自动修正全角、缺失斜杠等问题</div>
                                    </div>
                                    <div class="validation-item">
                                        <div class="validation-title">开学时间</div>
                                        <div class="validation-desc">标准：YYYY年MM月<br>如：2024年09月<br>自动修正日期格式、补零等</div>
                                    </div>
                                    <div class="validation-item">
                                        <div class="validation-title">申请费用</div>
                                        <div class="validation-desc">标准：数字+币种全称<br>如：150澳大利亚元<br>自动转换缩写、识别币种</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 院校匹配内容 -->
        <div id="universityContent" class="tab-content">
            <!-- 功能说明区域 - 院校匹配 -->
            <div class="info-section">
                <div class="info-grid">
                    <!-- 文件上传说明 -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-icon upload">📁</div>
                            <h3 class="info-card-title">文件上传</h3>
                        </div>
                        <div class="info-card-content">
                            <p><strong>院校数据库:</strong> 包含完整院校信息的Excel文件，需要包含院校ID和名称字段</p>
                            <br>
                            <p><strong>认可名单:</strong> 需要匹配院校ID的Excel文件，可包含中文名、英文名或混合格式的院校名称</p>
                        </div>
                    </div>

                    <!-- 匹配算法说明 -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-icon matching">⚡</div>
                            <h3 class="info-card-title">5级智能匹配</h3>
                        </div>
                        <div class="info-card-content">
                            <p>采用5级渐进式匹配策略，处理中英文混合、格式多样的院校名称:</p>
                            <button class="expand-toggle" onclick="toggleSection('university-matching')">
                                查看匹配规则 <span class="expand-icon">▼</span>
                            </button>
                            <div class="collapsible-content" id="university-matching-content">
                                <ul class="rule-list">
                                    <li class="rule-item">
                                        <span class="rule-priority priority-1">1</span>
                                        <div class="rule-text"><strong>精确匹配</strong><br>完全相同的中英文名称 (100%)</div>
                                    </li>
                                    <li class="rule-item">
                                        <span class="rule-priority priority-2">2</span>
                                        <div class="rule-text"><strong>标准化匹配</strong><br>去除标点、统一大小写后匹配 (95%)</div>
                                    </li>
                                    <li class="rule-item">
                                        <span class="rule-priority priority-3">3</span>
                                        <div class="rule-text"><strong>关键词匹配</strong><br>提取地区+类型关键词匹配 (85%)</div>
                                    </li>
                                    <li class="rule-item">
                                        <span class="rule-priority priority-4">4</span>
                                        <div class="rule-text"><strong>模糊匹配</strong><br>编辑距离算法 (70%)</div>
                                    </li>
                                    <li class="rule-item">
                                        <span class="rule-priority priority-5">5</span>
                                        <div class="rule-text"><strong>语义匹配</strong><br>简称展开、核心词匹配 (60%)</div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 结果输出说明 -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <div class="info-icon result">📊</div>
                            <h3 class="info-card-title">智能分析</h3>
                        </div>
                        <div class="info-card-content">
                            <p>基于置信度的智能结果分类和建议:</p>
                            <div style="margin-top: 12px;">
                                <p>🟢 <strong>高置信度 (>90%)</strong>: 自动匹配成功</p>
                                <p>🟡 <strong>中置信度 (70-90%)</strong>: 建议人工复核</p>
                                <p>🔴 <strong>低置信度 (<70%)</strong>: 需要人工处理</p>
                                <p>⚫ <strong>未匹配</strong>: 在数据库中未找到</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-card">
            <!-- 文件上传区 -->
            <div class="upload-section">
                <div class="upload-box" id="existingDataBox">
                    <div class="upload-icon">📊</div>
                    <h3 id="uploadTitle1">① 数据库现有数据</h3>
                    <p class="upload-text" id="uploadDesc1">上传包含存量专业数据的Excel文件<br>支持 .xlsx, .xls 格式</p>
                    <button class="upload-btn" onclick="document.getElementById('existingFile').click()">选择文件</button>
                    <input type="file" id="existingFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(this, 'existing')">
                    <div class="file-info" id="existingFileInfo"></div>
                </div>

                <div class="upload-box" id="newDataBox">
                    <div class="upload-icon">📋</div>
                    <h3 id="uploadTitle2">② 新爬取的待入库数据</h3>
                    <p class="upload-text" id="uploadDesc2">上传包含待处理的新专业信息的Excel文件<br>支持 .xlsx, .xls 格式</p>
                    <button class="upload-btn" onclick="document.getElementById('newFile').click()">选择文件</button>
                    <input type="file" id="newFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(this, 'new')">
                    <div class="file-info" id="newFileInfo"></div>
                </div>
            </div>

            <!-- 控制与状态区 -->
            <div class="control-section">
                <div class="button-group">
                    <button class="process-btn" id="processBtn" onclick="startProcessing()" disabled>
                        开始匹配与校验
                    </button>
                    <button class="export-btn" id="exportBtn" onclick="exportResults()">
                        导出处理结果 (.xlsx)
                    </button>
                </div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="status" id="statusMessage"></div>
            </div>

            <!-- 统计面板 -->
            <div class="statistics-section" id="statisticsSection">
                <div class="total-count-card">
                    <div class="total-count-number" id="totalCount">0</div>
                    <div class="total-count-label" id="totalCountLabel">总记录数</div>
                </div>
                <div class="match-stats-section">
                    <h4 class="match-stats-title" id="statsTitle">匹配统计</h4>
                    <div class="stats-grid" id="statsGrid">
                        <!-- 动态生成统计卡片 -->
                    </div>
                </div>
            </div>

            <!-- 结果预览区 -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h3>处理结果预览</h3>
                    <div class="legend" id="legendContainer">
                        <!-- 动态生成图例 -->
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <div class="table-container">
                        <table class="results-table" id="resultsTable">
                            <thead id="tableHeader"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentTab = 'major'; // 当前选中的功能
        let existingData = null;
        let newData = null;
        let processedData = null;
        let originalFileName = '';
        let universityMatcher = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            universityMatcher = new UniversityMatcher();
            setupDragAndDrop();
            updateUIForTab(currentTab);
        });

        // 切换功能标签
        function switchTab(tab) {
            if (currentTab === tab) return;
            
            // 重置状态
            resetAllStates();
            
            currentTab = tab;
            
            // 更新标签样式
            document.getElementById('majorTab').classList.toggle('active', tab === 'major');
            document.getElementById('universityTab').classList.toggle('active', tab === 'university');
            
            // 更新内容显示
            document.getElementById('majorContent').classList.toggle('active', tab === 'major');
            document.getElementById('universityContent').classList.toggle('active', tab === 'university');
            
            // 更新UI元素
            updateUIForTab(tab);
        }

        // 重置所有状态
        function resetAllStates() {
            existingData = null;
            newData = null;
            processedData = null;
            originalFileName = '';
            
            // 重置文件输入
            document.getElementById('existingFile').value = '';
            document.getElementById('newFile').value = '';
            document.getElementById('existingFileInfo').style.display = 'none';
            document.getElementById('newFileInfo').style.display = 'none';
            
            // 重置按钮状态
            document.getElementById('processBtn').disabled = true;
            document.getElementById('exportBtn').style.display = 'none';
            
            // 重置状态显示
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('statisticsSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
        }

        // 根据标签更新UI
        function updateUIForTab(tab) {
            const processBtn = document.getElementById('processBtn');
            const uploadTitle1 = document.getElementById('uploadTitle1');
            const uploadTitle2 = document.getElementById('uploadTitle2');
            const uploadDesc1 = document.getElementById('uploadDesc1');
            const uploadDesc2 = document.getElementById('uploadDesc2');
            const totalCountLabel = document.getElementById('totalCountLabel');
            const statsTitle = document.getElementById('statsTitle');
            
            if (tab === 'major') {
                processBtn.textContent = '开始匹配与校验';
                uploadTitle1.innerHTML = '① 数据库现有数据';
                uploadTitle2.innerHTML = '② 新爬取的待入库数据';
                uploadDesc1.innerHTML = '上传包含存量专业数据的Excel文件<br>支持 .xlsx, .xls 格式';
                uploadDesc2.innerHTML = '上传包含待处理的新专业信息的Excel文件<br>支持 .xlsx, .xls 格式';
                totalCountLabel.textContent = '总记录数';
                statsTitle.textContent = '匹配统计';
            } else {
                processBtn.textContent = '开始智能匹配';
                uploadTitle1.innerHTML = '① 中国院校数据库';
                uploadTitle2.innerHTML = '② 待匹配认可名单';
                uploadDesc1.innerHTML = '上传包含院校ID和名称的Excel文件<br>支持 .xlsx, .xls 格式';
                uploadDesc2.innerHTML = '上传需要匹配院校ID的Excel文件<br>支持中英文混合格式';
                totalCountLabel.textContent = '总待匹配记录数';
                statsTitle.textContent = '匹配结果统计';
            }
        }

        // 文件选择处理
        function handleFileSelect(input, type) {
            const file = input.files[0];
            if (!file) return;

            const infoElement = document.getElementById(type === 'existing' ? 'existingFileInfo' : 'newFileInfo');
            infoElement.style.display = 'block';
            infoElement.textContent = `已选择: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;

            if (type === 'new') {
                originalFileName = file.name.replace(/\.[^/.]+$/, "");
            }

            readExcelFile(file, type);
        }

        // 拖拽上传
        function setupDragAndDrop() {
            ['existingDataBox', 'newDataBox'].forEach(id => {
                const box = document.getElementById(id);
                const input = document.getElementById(id === 'existingDataBox' ? 'existingFile' : 'newFile');
                const type = id === 'existingDataBox' ? 'existing' : 'new';

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    box.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    box.addEventListener(eventName, () => box.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    box.addEventListener(eventName, () => box.classList.remove('dragover'), false);
                });

                box.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        input.files = files;
                        handleFileSelect(input, type);
                    }
                }, false);
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // 读取Excel文件
        async function readExcelFile(file, type) {
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (type === 'existing') {
                    existingData = jsonData;
                    console.log('现有数据已加载:', existingData.length, '条记录');
                } else {
                    newData = jsonData;
                    console.log('新数据已加载:', newData.length, '条记录');
                }
                
                checkIfCanProcess();
            } catch (error) {
                showStatus('文件读取失败: ' + error.message, 'error');
            }
        }

        // 检查是否可以开始处理
        function checkIfCanProcess() {
            const processBtn = document.getElementById('processBtn');
            if (existingData && newData) {
                processBtn.disabled = false;
                processBtn.style.opacity = '1';
            }
        }

        // 显示状态信息
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;
            statusElement.style.display = 'block';
        }

        // 更新进度条
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            progressFill.style.width = percent + '%';
        }

        // 开始处理 - 根据当前标签调用不同的处理函数
        async function startProcessing() {
            if (currentTab === 'major') {
                await startMajorProcessing();
            } else {
                await startUniversityMatching();
            }
        }

        // 专业匹配处理
        async function startMajorProcessing() {
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<div class="loading-spinner"></div>正在处理...';

            try {
                showStatus('正在读取文件...', 'processing');
                updateProgress(10);

                await new Promise(resolve => setTimeout(resolve, 500));

                showStatus('正在进行数据匹配...', 'processing');
                updateProgress(30);

                // 执行数据匹配
                const matchedData = await performDataMatching();
                updateProgress(60);

                showStatus('正在进行数据校验与修正...', 'processing');
                
                // 执行数据校验
                processedData = await performDataValidation(matchedData);
                updateProgress(90);

                showStatus('处理完成！', 'success');
                updateProgress(100);

                // 显示结果
                displayMajorResults();
                displayMajorStatistics();
                
                // 显示导出按钮和统计面板
                document.getElementById('exportBtn').style.display = 'inline-block';
                document.getElementById('statisticsSection').style.display = 'block';

            } catch (error) {
                showStatus('处理失败: ' + error.message, 'error');
                console.error('处理错误:', error);
            } finally {
                processBtn.innerHTML = '开始匹配与校验';
                processBtn.disabled = false;
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
            }
        }

        // 院校匹配处理
        async function startUniversityMatching() {
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<div class="loading-spinner"></div>正在智能匹配...';

            try {
                showStatus('正在初始化匹配引擎...', 'processing');
                updateProgress(10);

                await new Promise(resolve => setTimeout(resolve, 500));

                showStatus('正在执行智能匹配...', 'processing');
                updateProgress(30);

                // 执行批量匹配
                const queries = newData.map((record, index) => {
                    return {
                        index: index,
                        record: record,
                        name: extractUniversityName(record)
                    };
                });

                const matchResults = [];
                const total = queries.length;
                
                for (let i = 0; i < queries.length; i++) {
                    const query = queries[i];
                    // 使用v2.0增强版匹配算法
                    const result = universityMatcher.enhancedMatch(query.name, existingData);
                    
                    matchResults.push({
                        originalRecord: query.record,
                        queryName: query.name,
                        matchedRecord: result.match,
                        confidence: result.confidence,
                        level: result.level,
                        reason: result.reason,
                        // v2.0新增字段
                        status: result.status,
                        statusColor: result.statusColor,
                        action: result.action,
                        matchPath: result.matchPath,
                        hasConflict: result.hasConflict,
                        reviewSuggestion: result.reviewSuggestion,
                        debug: result.debug
                    });

                    // 更新进度
                    const progress = 30 + (i + 1) / total * 50;
                    updateProgress(progress);
                    
                    // 每100个记录暂停一次，避免阻塞UI
                    if (i % 100 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }

                processedData = matchResults;

                updateProgress(90);
                showStatus('正在生成报告...', 'processing');

                await new Promise(resolve => setTimeout(resolve, 300));

                showStatus('匹配完成！', 'success');
                updateProgress(100);

                // 显示结果
                displayUniversityResults();
                displayUniversityStatistics();
                
                // 显示导出按钮和统计面板
                document.getElementById('exportBtn').style.display = 'inline-block';
                document.getElementById('statisticsSection').style.display = 'block';

            } catch (error) {
                showStatus('匹配失败: ' + error.message, 'error');
                console.error('匹配错误:', error);
            } finally {
                processBtn.innerHTML = '开始智能匹配';
                processBtn.disabled = false;
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
            }
        }

        // 从记录中提取院校名称
        function extractUniversityName(record) {
            const nameFields = [
                'name', 'university_name', 'school_name', 'institution_name',
                '院校名称', '学校名称', '中文名称', '英文名称', 
                'chinese_name', 'english_name', '院校中文名', '院校英文名',
                '名称', '学校', '院校', 'Name', 'University', 'School'
            ];

            for (const field of nameFields) {
                if (record[field] && typeof record[field] === 'string') {
                    return record[field].trim();
                }
            }

            // 如果没找到明确字段，使用第一个非空文本字段
            for (const [key, value] of Object.entries(record)) {
                if (typeof value === 'string' && value.trim().length > 0) {
                    return value.trim();
                }
            }

            return '';
        }

        // 显示专业匹配统计
        function displayMajorStatistics() {
            if (!processedData) return;

            const total = processedData.length;
            
            // 匹配统计
            let matchSuccess = 0;
            let matchWarning = 0;
            let matchFail = 0;
            
            // 格式统计
            let formatOk = 0;
            let formatFixed = 0;
            let formatError = 0;

            processedData.forEach(record => {
                // 匹配统计
                if (record.matchLevel > 0) {
                    if (record.matchLevel === 4 || record.匹配状态.includes('建议复核')) {
                        matchWarning++;
                    } else {
                        matchSuccess++;
                    }
                } else {
                    matchFail++;
                }

                // 格式统计
                if (record.格式校验问题 === '无问题') {
                    formatOk++;
                } else if (record.格式校验问题.includes('已修正')) {
                    formatFixed++;
                } else {
                    formatError++;
                }
            });

            document.getElementById('totalCount').textContent = total;
            
            // 更新统计网格
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card stat-success">
                    <div class="stat-number">${matchSuccess}</div>
                    <div class="stat-label">匹配成功</div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-number">${matchWarning}</div>
                    <div class="stat-label">需要复核</div>
                </div>
                <div class="stat-card stat-error">
                    <div class="stat-number">${matchFail}</div>
                    <div class="stat-label">匹配失败</div>
                </div>
                <div class="stat-card stat-success">
                    <div class="stat-number">${formatOk}</div>
                    <div class="stat-label">格式正常</div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-number">${formatFixed}</div>
                    <div class="stat-label">已自动修复</div>
                </div>
                <div class="stat-card stat-error">
                    <div class="stat-number">${formatError}</div>
                    <div class="stat-label">需人工修复</div>
                </div>
            `;

            // 更新图例
            const legendContainer = document.getElementById('legendContainer');
            legendContainer.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color legend-success"></div>
                    <span>成功匹配，通过校验</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-warning"></div>
                    <span>模糊匹配，建议复核</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-error"></div>
                    <span>匹配失败或格式错误</span>
                </div>
            `;
        }

        // 显示院校匹配统计 (v2.0增强版)
        function displayUniversityStatistics() {
            if (!processedData) return;

            const total = processedData.length;
            
            // v2.0三级质量控制统计
            const qualityStats = {
                success: 0,      // 匹配成功 (≥90%置信度)
                review: 0,       // 需人工审核 (70-90%置信度) 
                failed: 0        // 匹配失败 (<70%置信度)
            };

            // 传统级别统计 (保留兼容性)
            const levelStats = {
                level1: 0, level2: 0, level3: 0, level4: 0, level5: 0, nomatch: 0
            };

            // 路径统计
            const pathStats = {
                chinese: 0,
                english: 0,
                mixed: 0
            };

            processedData.forEach(result => {
                // 质量控制统计
                if (result.status === "匹配成功") {
                    qualityStats.success++;
                } else if (result.status === "需人工审核") {
                    qualityStats.review++;
                } else {
                    qualityStats.failed++;
                }

                // 级别统计
                if (result.level === 0) {
                    levelStats.nomatch++;
                } else {
                    levelStats[`level${result.level}`]++;
                }

                // 路径统计
                if (result.matchPath === 'chinese') {
                    pathStats.chinese++;
                } else if (result.matchPath === 'english') {
                    pathStats.english++;
                } else {
                    pathStats.mixed++;
                }
            });

            document.getElementById('totalCount').textContent = total;
            
            // 更新统计网格 (v2.0三级质量控制)
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card stat-success">
                    <div class="stat-number">${qualityStats.success}</div>
                    <div class="stat-label">自动通过</div>
                    <div class="stat-percent">${(qualityStats.success / total * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card stat-review">
                    <div class="stat-number">${qualityStats.review}</div>
                    <div class="stat-label">需人工审核</div>
                    <div class="stat-percent">${(qualityStats.review / total * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card stat-failed">
                    <div class="stat-number">${qualityStats.failed}</div>
                    <div class="stat-label">匹配失败</div>
                    <div class="stat-percent">${(qualityStats.failed / total * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card stat-path">
                    <div class="stat-number">${pathStats.chinese}</div>
                    <div class="stat-label">中文路径</div>
                    <div class="stat-percent">${(pathStats.chinese / total * 100).toFixed(1)}%</div>
                </div>
                <div class="stat-card stat-path">
                    <div class="stat-number">${pathStats.english}</div>
                    <div class="stat-label">英文路径</div>
                    <div class="stat-percent">${(pathStats.english / total * 100).toFixed(1)}%</div>
                </div>
            `;

            // 更新图例 (v2.0三级质量控制)
            const legendContainer = document.getElementById('legendContainer');
            legendContainer.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color legend-success"></div>
                    <span>✅ 匹配成功 (≥90%置信度，自动通过)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-review"></div>
                    <span>⚠️ 需人工审核 (70-90%置信度)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-failed"></div>
                    <span>❌ 匹配失败 (<70%置信度，需重新录入)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-chinese"></div>
                    <span>🔵 中文路径匹配</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-english"></div>
                    <span>🟢 英文路径匹配</span>
                </div>
            `;
        }

        // 显示专业匹配结果
        function displayMajorResults() {
            const resultsSection = document.getElementById('resultsSection');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');

            resultsSection.style.display = 'block';

            if (!processedData || processedData.length === 0) return;

            // 生成表头
            const headers = [...Object.keys(processedData[0])].filter(key => key !== 'matchLevel');
            const frozenHeaders = ['专业ID', '匹配状态', '格式校验问题'];
            
            tableHeader.innerHTML = headers.map((header, index) => {
                let className = '';
                let frozenIndex = frozenHeaders.indexOf(header);
                if (frozenIndex !== -1) {
                    className = `frozen frozen-${frozenIndex + 1}`;
                }
                return `<th class="${className}">${header}</th>`;
            }).join('');

            // 生成表格内容
            tableBody.innerHTML = processedData.map(record => {
                const rowClass = getMajorRowClass(record);
                const cells = headers.map((header, index) => {
                    let value = record[header] || '';
                    if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    }
                    
                    let className = '';
                    let frozenIndex = frozenHeaders.indexOf(header);
                    if (frozenIndex !== -1) {
                        className = `frozen frozen-${frozenIndex + 1}`;
                    }
                    
                    // 处理过长的文本
                    let displayValue = value;
                    if (typeof value === 'string' && value.length > 30) {
                        displayValue = value.substring(0, 30) + '...';
                    }
                    
                    // 特殊处理格式校验问题列
                    if (header === '格式校验问题') {
                        if (value === '无问题') {
                            displayValue = '<span style="color: #22c55e; font-weight: 500;">✓ 无问题</span>';
                        } else if (value.includes('已修正')) {
                            displayValue = `<span class="validation-fixed">${displayValue}</span>`;
                        } else if (value && value !== '无问题') {
                            displayValue = `<span class="validation-issue">${displayValue}</span>`;
                        }
                    }
                    
                    return `<td class="${className}">${displayValue}</td>`;
                }).join('');
                
                return `<tr class="${rowClass}">${cells}</tr>`;
            }).join('');
        }

        // 显示院校匹配结果
        function displayUniversityResults() {
            const resultsSection = document.getElementById('resultsSection');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');

            resultsSection.style.display = 'block';

            if (!processedData || processedData.length === 0) return;

            // 生成表头 (v2.0增强版)
            const originalColumns = Object.keys(processedData[0].originalRecord);
            const headers = [
                ...originalColumns,
                '匹配院校ID',
                '匹配院校名称',
                '置信度',
                '匹配状态',
                '匹配方式',
                '匹配路径',
                '处理建议',
                '匹配原因'
            ];
            
            tableHeader.innerHTML = headers.map(header => 
                `<th>${header}</th>`
            ).join('');

            // 生成表格内容 (v2.0增强版)
            tableBody.innerHTML = processedData.map(result => {
                const rowClass = getEnhancedUniversityRowClass(result);
                const confidenceBadge = getConfidenceBadge(result.confidence);
                const statusBadge = getStatusBadge(result.status, result.statusColor);
                const pathBadge = getMatchPathBadge(result.matchPath);
                
                const cells = originalColumns.map(col => {
                    const value = result.originalRecord[col] || '';
                    const displayValue = typeof value === 'string' && value.length > 30 ? 
                        value.substring(0, 30) + '...' : value;
                    return `<td title="${value}">${displayValue}</td>`;
                });

                // 添加匹配结果列
                const matchedId = result.matchedRecord ? 
                    (result.matchedRecord.ID || result.matchedRecord.id || result.matchedRecord['院校ID'] || '') : '';
                const matchedName = result.matchedRecord ? 
                    extractUniversityName(result.matchedRecord) : '';

                cells.push(`<td>${matchedId}</td>`);
                cells.push(`<td title="${matchedName}">${matchedName.length > 20 ? matchedName.substring(0, 20) + '...' : matchedName}</td>`);
                cells.push(`<td>${confidenceBadge}</td>`);
                cells.push(`<td>${statusBadge}</td>`);
                cells.push(`<td>Level ${result.level}</td>`);
                cells.push(`<td>${pathBadge}</td>`);
                cells.push(`<td class="action-cell" title="${result.reviewSuggestion || result.action}">${result.action || '自动处理'}</td>`);
                cells.push(`<td title="${result.reason}">${result.reason}</td>`);
                
                return `<tr class="${rowClass}">${cells.join('')}</tr>`;
            }).join('');
        }

        // 获取专业匹配行样式类
        function getMajorRowClass(record) {
            // 优先检查格式校验问题
            if (record.格式校验问题 && record.格式校验问题 !== '无问题' && !record.格式校验问题.includes('已修正')) {
                return 'row-error';
            }
            
            // 再检查匹配状态
            if (record.matchLevel === 0 || record.匹配状态.includes('未找到匹配项')) {
                return 'row-error';
            } else if (record.matchLevel === 4 || record.匹配状态.includes('建议复核')) {
                return 'row-warning';
            } else if (record.专业ID && record.matchLevel > 0) {
                return 'row-success';
            }
            return '';
        }

        // 获取院校匹配行样式类
        function getUniversityRowClass(level) {
            if (level === 0) return 'row-nomatch';
            return `row-level${Math.min(level, 4)}`; // Level 5 也使用 level4 样式
        }

        // v2.0增强版行样式类 (基于三级质量控制)
        function getEnhancedUniversityRowClass(result) {
            if (result.status === "匹配成功") {
                return 'row-success';
            } else if (result.status === "需人工审核") {
                return 'row-warning';
            } else if (result.status === "匹配失败") {
                return 'row-error';
            }
            // 兜底逻辑
            return getUniversityRowClass(result.level);
        }

        // 获取状态徽章
        function getStatusBadge(status, statusColor) {
            if (!status) return '<span class="status-badge">未知</span>';
            
            const colorClass = status === "匹配成功" ? "success" : 
                              status === "需人工审核" ? "warning" : "error";
            
            return `<span class="status-badge ${colorClass}" style="color: ${statusColor || '#666'}">${status}</span>`;
        }

        // 获取匹配路径徽章
        function getMatchPathBadge(matchPath) {
            if (!matchPath) return '<span class="path-badge">未知</span>';
            
            const pathText = matchPath === 'chinese' ? '中文' : 
                            matchPath === 'english' ? '英文' : '混合';
            const pathClass = matchPath === 'chinese' ? 'chinese' : 
                             matchPath === 'english' ? 'english' : 'mixed';
            
            return `<span class="path-badge ${pathClass}">${pathText}</span>`;
        }

        // 获取置信度徽章
        function getConfidenceBadge(confidence) {
            const percent = Math.round(confidence * 100);
            let badgeClass = '';
            
            if (confidence >= 0.9) {
                badgeClass = 'confidence-high';
            } else if (confidence >= 0.7) {
                badgeClass = 'confidence-medium';
            } else {
                badgeClass = 'confidence-low';
            }
            
            return `<span class="confidence-badge ${badgeClass}">${percent}%</span>`;
        }

        // 切换信息区域展开/折叠
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const button = event.target.closest('.expand-toggle');
            const icon = button.querySelector('.expand-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                button.classList.remove('expanded');
                button.innerHTML = button.innerHTML.replace('收起详情', '查看详细功能')
                    .replace('收起规则', '查看匹配规则')
                    .replace('收起校验规则', '查看校验规则');
            } else {
                content.classList.add('expanded');
                button.classList.add('expanded');
                if (sectionId === 'overview') {
                    button.innerHTML = button.innerHTML.replace('查看详细功能', '收起详情');
                } else if (sectionId === 'matching') {
                    button.innerHTML = button.innerHTML.replace('查看匹配规则', '收起规则');
                } else if (sectionId === 'validation') {
                    button.innerHTML = button.innerHTML.replace('查看校验规则', '收起校验规则');
                } else if (sectionId === 'university-matching') {
                    button.innerHTML = button.innerHTML.replace('查看匹配规则', '收起规则');
                }
            }
        }

        // 导出结果
        function exportResults() {
            if (!processedData) return;

            let exportData = [];

            if (currentTab === 'major') {
                // 专业匹配导出
                exportData = processedData.map(record => {
                    const { matchLevel, ...exportRecord } = record;
                    return exportRecord;
                });
            } else {
                // 院校匹配导出
                exportData = processedData.map(result => {
                    const exportRecord = { ...result.originalRecord };
                    
                    // 添加匹配结果字段
                    exportRecord['匹配院校ID'] = result.matchedRecord ? 
                        (result.matchedRecord.ID || result.matchedRecord.id || result.matchedRecord['院校ID'] || '') : '';
                    exportRecord['匹配院校名称'] = result.matchedRecord ? 
                        extractUniversityName(result.matchedRecord) : '';
                    exportRecord['置信度'] = Math.round(result.confidence * 100) + '%';
                    exportRecord['匹配级别'] = result.level > 0 ? `Level ${result.level}` : '未匹配';
                    exportRecord['匹配方式'] = result.reason;
                    exportRecord['查询名称'] = result.queryName;
                    
                    return exportRecord;
                });
            }

            // 创建工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // 设置列宽
            const colWidths = [];
            const headers = Object.keys(exportData[0] || {});
            headers.forEach((header, index) => {
                const maxLength = Math.max(
                    header.length,
                    ...exportData.map(row => String(row[header] || '').length)
                );
                colWidths[index] = { wch: Math.min(maxLength + 2, 50) };
            });
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, '处理结果');

            // 生成文件名
            const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
            const suffix = currentTab === 'major' ? '专业匹配' : '院校匹配';
            const fileName = `${originalFileName}-${suffix}结果-${date}.xlsx`;

            // 导出文件
            XLSX.writeFile(wb, fileName);
        }

        // 以下是专业匹配的具体实现函数
        // [这里需要包含原有的专业匹配算法代码]
    </script>

    <!-- 中国院校匹配算法 -->
    <script>
        // 中国院校智能匹配算法类
        class UniversityMatcher {
            constructor() {
                // 常见院校简称映射
                this.abbreviationMap = {
                    "北大": "北京大学",
                    "清华": "清华大学",
                    "复旦": "复旦大学",
                    "上交": "上海交通大学",
                    "西交": "西安交通大学", 
                    "中科大": "中国科学技术大学",
                    "哈工大": "哈尔滨工业大学",
                    "北航": "北京航空航天大学",
                    "北理工": "北京理工大学",
                    "华科": "华中科技大学",
                    "中大": "中山大学",
                    "华南理工": "华南理工大学",
                    "川大": "四川大学",
                    "重大": "重庆大学",
                    "西工大": "西北工业大学",
                    "北师大": "北京师范大学",
                    "华师大": "华东师范大学",
                    "南师大": "南京师范大学",
                    "华师": "华中师范大学",
                    "陕师大": "陕西师范大学",
                    "东师": "东北师范大学",
                    "西南大学": "西南师范大学",
                    "湖师大": "湖南师范大学",
                    "华农": "华中农业大学",
                    "南农": "南京农业大学",
                    "西农": "西北农林科技大学",
                    "中农": "中国农业大学",
                };

                // 常见英文缩写映射
                this.englishAbbreviations = {
                    "univ": "university",
                    "coll": "college",
                    "inst": "institute",
                    "tech": "technology",
                    "sci": "science",
                    "eng": "engineering",
                    "med": "medical",
                    "agri": "agriculture",
                    "norm": "normal",
                };

                // 院校类型关键词
                this.universityTypes = [
                    "大学", "学院", "学校", "university", "college", "institute", "school"
                ];

                // 地区关键词
                this.regionKeywords = [
                    "北京", "上海", "天津", "重庆", "广东", "江苏", "浙江", "山东", 
                    "河南", "湖北", "湖南", "河北", "安徽", "福建", "江西", "四川",
                    "陕西", "山西", "辽宁", "吉林", "黑龙江", "广西", "云南", "贵州",
                    "青海", "甘肃", "新疆", "西藏", "宁夏", "内蒙古", "海南", "台湾",
                    "香港", "澳门"
                ];
            }

            // 主匹配函数
            match(queryName, database) {
                if (!queryName || !database || database.length === 0) {
                    return { match: null, confidence: 0, level: 0, reason: "输入为空或数据库为空" };
                }

                // Level 1: 精确匹配
                let result = this.exactMatch(queryName, database);
                if (result.match) {
                    return { ...result, level: 1, reason: "精确匹配" };
                }

                // Level 2: 标准化匹配
                result = this.normalizedMatch(queryName, database);
                if (result.match) {
                    return { ...result, level: 2, reason: "标准化匹配" };
                }

                // Level 3: 关键词匹配
                result = this.keywordMatch(queryName, database);
                if (result.match) {
                    return { ...result, level: 3, reason: "关键词匹配" };
                }

                // Level 4: 模糊匹配
                result = this.fuzzyMatch(queryName, database);
                if (result.match) {
                    return { ...result, level: 4, reason: "模糊匹配" };
                }

                // Level 5: 语义匹配 (简化版)
                result = this.semanticMatch(queryName, database);
                if (result.match) {
                    return { ...result, level: 5, reason: "语义匹配" };
                }

                return { match: null, confidence: 0, level: 0, reason: "未找到匹配" };
            }

            // Level 1: 精确匹配
            exactMatch(queryName, database) {
                for (const record of database) {
                    // 检查所有可能的名称字段
                    const nameFields = this.extractNameFields(record);
                    
                    for (const field of nameFields) {
                        if (field && field.trim() === queryName.trim()) {
                            return { match: record, confidence: 1.0 };
                        }
                    }
                }
                return { match: null, confidence: 0 };
            }

            // Level 2: 标准化匹配
            normalizedMatch(queryName, database) {
                const normalizedQuery = this.normalizeText(queryName);
                
                for (const record of database) {
                    const nameFields = this.extractNameFields(record);
                    
                    for (const field of nameFields) {
                        if (field && this.normalizeText(field) === normalizedQuery) {
                            return { match: record, confidence: 0.95 };
                        }
                    }
                }
                return { match: null, confidence: 0 };
            }

            // Level 3: 关键词匹配
            keywordMatch(queryName, database) {
                const queryKeywords = this.extractKeywords(queryName);
                if (queryKeywords.length === 0) {
                    return { match: null, confidence: 0 };
                }

                let bestMatch = null;
                let bestScore = 0;

                for (const record of database) {
                    const nameFields = this.extractNameFields(record);
                    
                    for (const field of nameFields) {
                        if (!field) continue;
                        
                        const recordKeywords = this.extractKeywords(field);
                        const similarity = this.calculateKeywordSimilarity(queryKeywords, recordKeywords);
                        
                        if (similarity > bestScore && similarity >= 0.8) {
                            bestScore = similarity;
                            bestMatch = record;
                        }
                    }
                }

                return bestMatch ? 
                    { match: bestMatch, confidence: bestScore } : 
                    { match: null, confidence: 0 };
            }

            // Level 4: 模糊匹配
            fuzzyMatch(queryName, database) {
                const normalizedQuery = this.normalizeText(queryName);
                let bestMatch = null;
                let bestScore = 0;

                for (const record of database) {
                    const nameFields = this.extractNameFields(record);
                    
                    for (const field of nameFields) {
                        if (!field) continue;
                        
                        const normalizedField = this.normalizeText(field);
                        
                        // 编辑距离相似度
                        const editSimilarity = this.calculateEditSimilarity(normalizedQuery, normalizedField);
                        
                        // 包含关系检查
                        const containsSimilarity = this.calculateContainsSimilarity(normalizedQuery, normalizedField);
                        
                        // 取最高分
                        const similarity = Math.max(editSimilarity, containsSimilarity);
                        
                        if (similarity > bestScore && similarity >= 0.7) {
                            bestScore = similarity;
                            bestMatch = record;
                        }
                    }
                }

                return bestMatch ? 
                    { match: bestMatch, confidence: bestScore } : 
                    { match: null, confidence: 0 };
            }

            // Level 5: 语义匹配 (简化版)
            semanticMatch(queryName, database) {
                // 尝试简称映射
                const expandedName = this.expandAbbreviation(queryName);
                if (expandedName !== queryName) {
                    return this.normalizedMatch(expandedName, database);
                }

                // 尝试部分匹配
                let bestMatch = null;
                let bestScore = 0;

                const queryCore = this.extractCoreWords(queryName);
                
                for (const record of database) {
                    const nameFields = this.extractNameFields(record);
                    
                    for (const field of nameFields) {
                        if (!field) continue;
                        
                        const recordCore = this.extractCoreWords(field);
                        const similarity = this.calculateCoreSimilarity(queryCore, recordCore);
                        
                        if (similarity > bestScore && similarity >= 0.6) {
                            bestScore = similarity;
                            bestMatch = record;
                        }
                    }
                }

                return bestMatch ? 
                    { match: bestMatch, confidence: bestScore } : 
                    { match: null, confidence: 0 };
            }

            // 从记录中提取所有可能的名称字段
            extractNameFields(record) {
                const fields = [];
                
                // 常见的名称字段
                const nameColumns = [
                    'name', 'university_name', 'school_name', 'institution_name',
                    '院校名称', '学校名称', '中文名称', '英文名称', 
                    'chinese_name', 'english_name', '院校中文名', '院校英文名',
                    '名称', '学校', '院校', 'Name', 'University', 'School'
                ];

                for (const col of nameColumns) {
                    if (record[col]) {
                        fields.push(record[col]);
                    }
                }

                // 如果没有找到明确的名称字段，尝试第一个文本字段
                if (fields.length === 0) {
                    const firstTextValue = Object.values(record).find(value => 
                        typeof value === 'string' && value.trim().length > 0
                    );
                    if (firstTextValue) {
                        fields.push(firstTextValue);
                    }
                }

                return fields;
            }

            // 文本标准化处理
            normalizeText(text) {
                if (!text) return '';
                
                return text.toString()
                    .toLowerCase()
                    // 去除标点符号
                    .replace(/[.,;:!?'"()[\]{}—–-]/g, '')
                    // 统一空格
                    .replace(/\s+/g, ' ')
                    .trim()
                    // 全角转半角
                    .replace(/[\uFF01-\uFF5E]/g, function(char) {
                        return String.fromCharCode(char.charCodeAt(0) - 0xFEE0);
                    })
                    // 中文标点转换
                    .replace(/[，。；：！？'"（）【】｛｝]/g, '');
            }

            // 提取关键词
            extractKeywords(text) {
                if (!text) return [];
                
                const normalized = this.normalizeText(text);
                const keywords = [];

                // 提取中文地区词
                for (const region of this.regionKeywords) {
                    if (normalized.includes(region)) {
                        keywords.push(region);
                    }
                }

                // 提取院校类型词
                for (const type of this.universityTypes) {
                    if (normalized.includes(type.toLowerCase())) {
                        keywords.push(type);
                    }
                }

                // 提取其他重要词汇（长度>=2的词）
                const words = normalized.split(/[\s,，]+/).filter(word => 
                    word.length >= 2 && 
                    !this.universityTypes.includes(word) &&
                    !this.regionKeywords.includes(word)
                );
                keywords.push(...words);

                return [...new Set(keywords)]; // 去重
            }

            // 计算关键词相似度
            calculateKeywordSimilarity(keywords1, keywords2) {
                if (keywords1.length === 0 || keywords2.length === 0) {
                    return 0;
                }

                const set1 = new Set(keywords1.map(k => k.toLowerCase()));
                const set2 = new Set(keywords2.map(k => k.toLowerCase()));
                
                const intersection = new Set([...set1].filter(x => set2.has(x)));
                const union = new Set([...set1, ...set2]);
                
                return intersection.size / union.size;
            }

            // 计算编辑距离相似度
            calculateEditSimilarity(str1, str2) {
                if (str1 === str2) return 1.0;
                if (str1.length === 0 || str2.length === 0) return 0;

                const distance = this.levenshteinDistance(str1, str2);
                const maxLength = Math.max(str1.length, str2.length);
                
                return 1 - (distance / maxLength);
            }

            // 计算包含关系相似度
            calculateContainsSimilarity(str1, str2) {
                const shorter = str1.length <= str2.length ? str1 : str2;
                const longer = str1.length > str2.length ? str1 : str2;
                
                if (longer.includes(shorter)) {
                    return shorter.length / longer.length;
                }
                
                return 0;
            }

            // 编辑距离算法
            levenshteinDistance(str1, str2) {
                const matrix = [];

                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }

                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }

                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1, // 替换
                                matrix[i][j - 1] + 1,     // 插入
                                matrix[i - 1][j] + 1      // 删除
                            );
                        }
                    }
                }

                return matrix[str2.length][str1.length];
            }

            // 展开简称
            expandAbbreviation(text) {
                if (!text) return text;
                
                // 中文简称展开
                for (const [abbr, full] of Object.entries(this.abbreviationMap)) {
                    if (text.includes(abbr)) {
                        return text.replace(abbr, full);
                    }
                }

                return text;
            }

            // 提取核心词汇
            extractCoreWords(text) {
                if (!text) return [];
                
                const normalized = this.normalizeText(text);
                const words = normalized.split(/[\s,，]+/);
                
                // 过滤掉常见的无意义词汇
                const stopWords = ['的', '和', '与', 'of', 'and', 'the', 'in', 'at', 'for'];
                
                return words.filter(word => 
                    word.length >= 2 && 
                    !stopWords.includes(word.toLowerCase())
                );
            }

            // 计算核心词相似度
            calculateCoreSimilarity(core1, core2) {
                if (core1.length === 0 || core2.length === 0) {
                    return 0;
                }

                let matches = 0;
                const maxLength = Math.max(core1.length, core2.length);

                for (const word1 of core1) {
                    for (const word2 of core2) {
                        if (word1 === word2 || 
                            word1.includes(word2) || 
                            word2.includes(word1)) {
                            matches++;
                            break;
                        }
                    }
                }

                return matches / maxLength;
            }

            // ========== v2.0 双路径匹配新增功能 ==========
            
            // 智能语言分离器
            separateLanguages(text) {
                if (!text) return { chinese: '', english: '' };
                
                const cleanText = text.toString().trim();
                
                // 提取中文部分 (包括中文标点)
                const chineseMatches = cleanText.match(/[\u4e00-\u9fff\u3000-\u303f\uff00-\uffef]+/g);
                const chinese = chineseMatches ? chineseMatches.join('').trim() : '';
                
                // 提取英文部分 (包括数字、标点、空格)
                const englishMatches = cleanText.match(/[a-zA-Z0-9\s\.,;:!?'"()\[\]{}\-&]+/g);
                const english = englishMatches ? englishMatches.join(' ').replace(/\s+/g, ' ').trim() : '';
                
                return {
                    chinese: this.cleanLanguagePart(chinese),
                    english: this.cleanLanguagePart(english)
                };
            }
            
            // 清理语言片段
            cleanLanguagePart(text) {
                if (!text) return '';
                
                return text
                    .replace(/^\s*[^\w\u4e00-\u9fff]+/, '') // 去除开头的符号
                    .replace(/[^\w\u4e00-\u9fff]+\s*$/, '') // 去除结尾的符号
                    .replace(/\s+/g, ' ') // 统一空格
                    .trim();
            }
            
            // 增强版主匹配函数 (双路径匹配)
            enhancedMatch(queryName, database) {
                if (!queryName || !database || database.length === 0) {
                    return this.createFailureResult(queryName, "输入为空或数据库为空");
                }
                
                // Step 1: 语言分离
                const { chinese, english } = this.separateLanguages(queryName);
                
                // 记录原始匹配过程用于调试
                const debug = {
                    original: queryName,
                    separated: { chinese, english },
                    chineseResult: null,
                    englishResult: null
                };
                
                // Step 2: 双路径匹配
                let chineseResult = null;
                let englishResult = null;
                
                if (chinese && chinese.length >= 2) {
                    chineseResult = this.match(chinese, database);
                    debug.chineseResult = chineseResult;
                }
                
                if (english && english.length >= 3) {
                    englishResult = this.match(english, database);
                    debug.englishResult = englishResult;
                }
                
                // Step 3: 智能决策选择
                const selectedResult = this.selectBestResult(chineseResult, englishResult, debug);
                
                // Step 4: 三级质量控制
                return this.applyQualityControl(selectedResult, queryName, debug);
            }
            
            // 智能决策器
            selectBestResult(chineseResult, englishResult, debug = {}) {
                // 策略1: 中文完全匹配优先
                if (chineseResult && this.isExactMatch(chineseResult)) {
                    debug.decision = "中文完全匹配优先";
                    return { ...chineseResult, matchPath: 'chinese' };
                }
                
                // 策略2: 英文完全匹配补充
                if ((!chineseResult || !this.isExactMatch(chineseResult)) && 
                    englishResult && this.isExactMatch(englishResult)) {
                    debug.decision = "英文完全匹配补充";
                    return { ...englishResult, matchPath: 'english' };
                }
                
                // 策略3: 择优选择
                if (!chineseResult && !englishResult) {
                    debug.decision = "两路径均无结果";
                    return null;
                }
                
                if (!chineseResult) {
                    debug.decision = "仅英文路径有结果";
                    return { ...englishResult, matchPath: 'english' };
                }
                
                if (!englishResult) {
                    debug.decision = "仅中文路径有结果";
                    return { ...chineseResult, matchPath: 'chinese' };
                }
                
                // 检测冲突
                const hasConflict = this.detectConflict(chineseResult, englishResult);
                debug.hasConflict = hasConflict;
                
                // 冲突解决策略
                if (hasConflict) {
                    // 精确匹配优先
                    if (chineseResult.level < englishResult.level) {
                        debug.decision = "中文匹配级别更高";
                        return { ...chineseResult, matchPath: 'chinese', hasConflict: true };
                    }
                    if (englishResult.level < chineseResult.level) {
                        debug.decision = "英文匹配级别更高";
                        return { ...englishResult, matchPath: 'english', hasConflict: true };
                    }
                    
                    // 置信度差距判断
                    const confidenceDiff = Math.abs(chineseResult.confidence - englishResult.confidence);
                    if (confidenceDiff > 0.15) {
                        const better = chineseResult.confidence > englishResult.confidence ? chineseResult : englishResult;
                        const path = chineseResult.confidence > englishResult.confidence ? 'chinese' : 'english';
                        debug.decision = `置信度差距显著，选择${path}`;
                        return { ...better, matchPath: path, hasConflict: true };
                    }
                    
                    // 中文优势策略
                    debug.decision = "冲突情况下中文优先";
                    return { ...chineseResult, matchPath: 'chinese', hasConflict: true };
                }
                
                // 无冲突情况，选择置信度更高者
                const better = chineseResult.confidence >= englishResult.confidence ? chineseResult : englishResult;
                const path = chineseResult.confidence >= englishResult.confidence ? 'chinese' : 'english';
                debug.decision = `择优选择${path}`;
                return { ...better, matchPath: path, hasConflict: false };
            }
            
            // 判断是否为完全匹配
            isExactMatch(result) {
                return result && result.level <= 2 && result.confidence >= 0.98;
            }
            
            // 检测匹配结果冲突
            detectConflict(result1, result2) {
                if (!result1 || !result2 || !result1.match || !result2.match) {
                    return false;
                }
                
                // 检查是否匹配到不同院校
                const id1 = result1.match['中国院校ID'] || result1.match['院校ID'] || result1.match['ID'] || '';
                const id2 = result2.match['中国院校ID'] || result2.match['院校ID'] || result2.match['ID'] || '';
                
                return id1 && id2 && id1 !== id2;
            }
            
            // 三级质量控制
            applyQualityControl(result, originalQuery, debug = {}) {
                if (!result || result.confidence < 0.7) {
                    return {
                        match: null,
                        confidence: 0,
                        level: 0,
                        status: "匹配失败",
                        statusColor: "#ff4757",
                        action: "需要补充院校信息或检查名称格式",
                        reason: "置信度过低或无匹配结果",
                        originalQuery: originalQuery,
                        debug: debug
                    };
                }
                
                if (result.confidence < 0.9) {
                    return {
                        ...result,
                        status: "需人工审核",
                        statusColor: "#ffa502",
                        action: "置信度偏低，建议人工确认",
                        originalQuery: originalQuery,
                        debug: debug,
                        reviewSuggestion: this.generateReviewSuggestion(result)
                    };
                }
                
                return {
                    ...result,
                    status: "匹配成功",
                    statusColor: "#26de81",
                    action: "自动通过",
                    originalQuery: originalQuery,
                    debug: debug
                };
            }
            
            // 生成人工审核建议
            generateReviewSuggestion(result) {
                const suggestions = [];
                
                if (result.confidence >= 0.85) {
                    suggestions.push("🟢 建议通过：置信度较高");
                }
                
                if (result.level <= 2) {
                    suggestions.push("🟢 建议通过：精确/标准化匹配");
                }
                
                if (result.hasConflict) {
                    suggestions.push("🟡 注意：中英文匹配结果不一致");
                }
                
                if (result.matchPath === 'chinese') {
                    suggestions.push("🔵 基于：中文路径匹配");
                } else if (result.matchPath === 'english') {
                    suggestions.push("🔵 基于：英文路径匹配");
                }
                
                return suggestions.length > 0 ? suggestions.join(" | ") : "请仔细核对匹配结果";
            }
            
            // 创建失败结果
            createFailureResult(originalQuery, reason) {
                return {
                    match: null,
                    confidence: 0,
                    level: 0,
                    status: "匹配失败",
                    statusColor: "#ff4757",
                    action: "检查输入格式",
                    reason: reason,
                    originalQuery: originalQuery
                };
            }
        }

        // ========== 专业匹配算法实现 ==========

        // 数据匹配核心逻辑
        async function performDataMatching() {
            const results = [];

            for (let i = 0; i < newData.length; i++) {
                const newRecord = newData[i];
                let matchResult = {
                    ...newRecord,
                    专业ID: '',
                    匹配状态: '',
                    格式校验问题: '',
                    matchLevel: 0 // 0-未匹配, 1-URL, 2-编码, 3-英文名, 4-中文名
                };

                // 1. URL精确匹配
                if (newRecord.专业链接) {
                    const normalizedNewUrl = normalizeUrl(newRecord.专业链接);
                    for (const existing of existingData) {
                        if (existing.专业链接 && normalizeUrl(existing.专业链接) === normalizedNewUrl) {
                            matchResult.专业ID = existing.ID || existing.专业ID || '';
                            matchResult.匹配状态 = '通过专业链接精确匹配';
                            matchResult.matchLevel = 1;
                            break;
                        }
                    }
                }

                // 2. 课程编码精确匹配
                if (!matchResult.专业ID && newRecord.课程编码) {
                    for (const existing of existingData) {
                        if (existing.课程编码 && existing.课程编码 === newRecord.课程编码) {
                            matchResult.专业ID = existing.ID || existing.专业ID || '';
                            matchResult.匹配状态 = '通过课程编码精确匹配';
                            matchResult.matchLevel = 2;
                            break;
                        }
                    }
                }

                // 3. 英文名+学位等级智能匹配
                if (!matchResult.专业ID && newRecord.专业英文名 && newRecord.学位等级) {
                    const newEnglishKey = normalizeEnglishName(newRecord.专业英文名, newRecord.学位等级);
                    for (const existing of existingData) {
                        if (existing.专业英文名 && existing.学位等级) {
                            const existingEnglishKey = normalizeEnglishName(existing.专业英文名, existing.学位等级);
                            if (newEnglishKey === existingEnglishKey) {
                                matchResult.专业ID = existing.ID || existing.专业ID || '';
                                matchResult.匹配状态 = '通过专业英文名+学位等级精确匹配';
                                matchResult.matchLevel = 3;
                                break;
                            }
                        }
                    }
                }

                // 4. 英文名+学位名称模糊匹配
                if (!matchResult.专业ID && newRecord.专业英文名 && newRecord.学位名称) {
                    let bestMatch = null;
                    let bestSimilarity = 0;
                    
                    for (const existing of existingData) {
                        if (existing.专业英文名 && existing.学位名称 === newRecord.学位名称) {
                            const similarity = calculateStringSimilarity(
                                normalizeTextForMajor(newRecord.专业英文名), 
                                normalizeTextForMajor(existing.专业英文名)
                            );
                            if (similarity > 0.95 && similarity > bestSimilarity) {
                                bestMatch = existing;
                                bestSimilarity = similarity;
                            }
                        }
                    }

                    if (bestMatch) {
                        matchResult.专业ID = bestMatch.ID || bestMatch.专业ID || '';
                        matchResult.匹配状态 = `通过专业英文名模糊匹配 (相似度${(bestSimilarity * 100).toFixed(1)}%)，建议复核`;
                        matchResult.matchLevel = 4;
                    }
                }

                // 如果未匹配到
                if (!matchResult.专业ID) {
                    matchResult.匹配状态 = '未找到匹配项';
                }

                results.push(matchResult);
            }

            return results;
        }

        // 数据校验与修正
        async function performDataValidation(matchedData) {
            for (const record of matchedData) {
                const validationResults = [];
                const fixedResults = [];

                // 校验学制
                if (record.学制) {
                    const { corrected, isValid, error, wasFixed } = validateAndCorrectDuration(record.学制);
                    record.学制 = corrected;
                    if (wasFixed) {
                        fixedResults.push(`学制已修正`);
                    }
                    if (!isValid) {
                        validationResults.push(error);
                    }
                }

                // 校验开学时间
                if (record.开学时间) {
                    const { corrected, isValid, error, wasFixed } = validateAndCorrectStartTime(record.开学时间);
                    record.开学时间 = corrected;
                    if (wasFixed) {
                        fixedResults.push(`开学时间已修正`);
                    }
                    if (!isValid) {
                        validationResults.push(error);
                    }
                }

                // 校验申请费用
                if (record.申请费用) {
                    const { corrected, isValid, error, wasFixed } = validateAndCorrectApplicationFee(record.申请费用);
                    record.申请费用 = corrected;
                    if (wasFixed) {
                        fixedResults.push(`申请费用已修正`);
                    }
                    if (!isValid) {
                        validationResults.push(error);
                    }
                }

                // 设置格式校验问题列
                if (validationResults.length > 0) {
                    record.格式校验问题 = validationResults.join('；');
                } else if (fixedResults.length > 0) {
                    record.格式校验问题 = fixedResults.join('；');
                } else {
                    record.格式校验问题 = '无问题';
                }
            }

            return matchedData;
        }

        // 专业匹配文本标准化
        function normalizeTextForMajor(text) {
            if (!text) return '';
            return text.toLowerCase()
                       .replace(/[()&\-\s]/g, '')
                       .trim();
        }

        // URL标准化
        function normalizeUrl(url) {
            if (!url) return '';
            return url.toLowerCase()
                      .replace(/^https?:\/\//, '')
                      .replace(/\/$/, '');
        }

        // 英文名标准化
        function normalizeEnglishName(englishName, degree) {
            if (!englishName || !degree) return '';
            
            const normalized = normalizeTextForMajor(englishName);
            const normalizedDegree = normalizeTextForMajor(degree);
            
            // 如果英文名已包含学位信息，不重复添加
            if (normalized.includes(normalizedDegree) || 
                normalized.includes('bachelor') || 
                normalized.includes('master') || 
                normalized.includes('doctor') ||
                normalized.includes('phd')) {
                return normalized;
            }
            
            return normalized + normalizedDegree;
        }

        // 申请费用校验与修正
        function validateAndCorrectApplicationFee(fee) {
            if (!fee) return { corrected: '', isValid: true, error: '', wasFixed: false };

            const original = fee.toString().trim();
            let corrected = original;
            let wasFixed = false;

            // 币种映射表
            const currencyMapping = {
                'AUD': '澳大利亚元', '澳元': '澳大利亚元', '澳币': '澳大利亚元', '澳大利亚币': '澳大利亚元',
                'USD': '美元', '美金': '美元', '美国元': '美元', '美国美元': '美元',
                'GBP': '英镑', '英国英镑': '英镑', '英国镑': '英镑',
                'EUR': '欧元', '欧盟元': '欧元',
                'CAD': '加拿大元', '加元': '加拿大元', '加币': '加拿大元', '加拿大币': '加拿大元',
                'NZD': '新西兰元', '纽元': '新西兰元', '新西兰币': '新西兰元',
                'JPY': '日元', '日币': '日元', '日本元': '日元', '日本币': '日元',
                'CNY': '人民币', '元': '人民币', '中国元': '人民币', 'RMB': '人民币',
                'CHF': '瑞士法郎', '瑞郎': '瑞士法郎',
                'SGD': '新加坡元', '新币': '新加坡元'
            };

            // 清理和提取逻辑...
            corrected = corrected
                .replace(/申请费用[：:]/g, '')
                .replace(/费用[：:]/g, '')
                .replace(/[。，,;；]/g, '')
                .replace(/\s+/g, '');

            const numberMatch = corrected.match(/(\d+(?:\.\d+)?)/);
            if (!numberMatch) {
                return { corrected: original, isValid: false, error: '申请费用中未找到有效数字', wasFixed: false };
            }
            const amount = numberMatch[1];

            let currency = '';
            for (const [key, value] of Object.entries(currencyMapping)) {
                if (corrected.includes(key)) {
                    currency = value;
                    break;
                }
            }

            if (!currency) {
                const chineseCurrencies = ['澳大利亚元', '美元', '英镑', '欧元', '加拿大元', '新西兰元', '日元', '人民币', '瑞士法郎', '新加坡元'];
                for (const curr of chineseCurrencies) {
                    if (corrected.includes(curr)) {
                        currency = curr;
                        break;
                    }
                }
            }

            if (!currency) {
                return { corrected: original, isValid: false, error: '申请费用中未识别到有效币种', wasFixed: false };
            }

            const standardFormat = `${amount}${currency}`;
            wasFixed = original !== standardFormat;

            return {
                corrected: standardFormat,
                isValid: true,
                error: '',
                wasFixed: wasFixed
            };
        }

        // 字符串相似度计算（编辑距离）
        function calculateStringSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            if (str1 === str2) return 1;

            const matrix = [];
            const len1 = str1.length;
            const len2 = str2.length;

            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            const maxLen = Math.max(len1, len2);
            return (maxLen - matrix[len2][len1]) / maxLen;
        }

        // 学制校验与修正
        function validateAndCorrectDuration(duration) {
            if (!duration) return { corrected: '', isValid: true, error: '', wasFixed: false };

            const original = duration.toString().trim();
            let corrected = original;
            let wasFixed = false;

            // 标准化处理
            corrected = corrected
                .replace(/／/g, '/') 
                .replace(/，/g, ',') 
                .replace(/\s+/g, '')
                .replace(/个学期/g, '学期')
                .replace(/（/g, '(')
                .replace(/）/g, ')')
                .replace(/；/g, ';');

            // 自动补全格式
            corrected = corrected
                .replace(/(\d+(\.\d+)?)年/g, '$1/年')
                .replace(/(\d+(\.\d+)?)月/g, '$1/月')
                .replace(/(\d+(\.\d+)?)周/g, '$1/周')
                .replace(/(\d+(\.\d+)?)学期/g, '$1/学期')
                .replace(/(\d+(\.\d+)?)学分/g, '$1/学分');

            corrected = corrected.replace(/(\d+(\.\d+)?)(年|月|周|学期|学分)/g, '$1/$3');
            corrected = corrected.replace(/\/+/g, '/');
            corrected = corrected.replace(/[;；]/g, ',');

            wasFixed = original !== corrected;

            // 验证格式
            const validUnits = ['年', '月', '周', '学期', '学分'];
            const parts = corrected.split(',').filter(p => p.trim());
            let isValid = true;
            let error = '';

            if (parts.length === 0) {
                return { corrected: original, isValid: false, error: '学制格式无效', wasFixed: false };
            }

            for (const part of parts) {
                const trimmedPart = part.trim();
                if (!trimmedPart.includes('/')) {
                    const match = trimmedPart.match(/^(\d+(?:\.\d+)?)(年|月|周|学期|学分)$/);
                    if (match) {
                        corrected = corrected.replace(trimmedPart, `${match[1]}/${match[2]}`);
                        wasFixed = true;
                        continue;
                    } else {
                        isValid = false;
                        error = `学制'${trimmedPart}'格式错误，应为"数字/单位"格式`;
                        break;
                    }
                }

                const [num, unit] = trimmedPart.split('/');
                if (!/^\d+(\.\d+)?$/.test(num)) {
                    isValid = false;
                    error = `学制数值'${num}'格式错误，应为数字`;
                    break;
                }

                if (!validUnits.includes(unit)) {
                    isValid = false;
                    error = `学制单位'${unit}'无效，有效单位：${validUnits.join('、')}`;
                    break;
                }
            }

            return { corrected, isValid, error, wasFixed };
        }

        // 开学时间校验与修正
        function validateAndCorrectStartTime(startTime) {
            if (!startTime) return { corrected: '', isValid: true, error: '', wasFixed: false };

            const original = startTime.toString().trim();
            let corrected = original;
            let wasFixed = false;

            // 标准化处理
            corrected = corrected
                .replace(/[.\/]/g, '-')
                .replace(/\s+/g, '')
                .replace(/[；;]/g, ',')
                .replace(/，/g, ',');

            // 格式转换
            corrected = corrected.replace(/(\d{4})年(\d{1,2})月/g, '$1-$2');
            corrected = corrected.replace(/(\d{4})[./](\d{1,2})/g, '$1-$2');
            corrected = corrected.replace(/(\d{4})-(\d)(?![0-9])/g, '$1-0$2');
            corrected = corrected.replace(/(\d{1,2})-(\d{4})/g, '$2-$1');

            wasFixed = original !== corrected;

            // 验证格式
            const parts = corrected.split(',').filter(p => p.trim());
            let isValid = true;
            let error = '';

            if (parts.length === 0) {
                return { corrected: original, isValid: false, error: '开学时间格式无效', wasFixed: false };
            }

            for (let i = 0; i < parts.length; i++) {
                let part = parts[i].trim();
                
                if (!/^\d{4}-\d{2}$/.test(part)) {
                    const yearMonthMatch = part.match(/(\d{4}).*?(\d{1,2})/);
                    if (yearMonthMatch) {
                        const year = yearMonthMatch[1];
                        const month = yearMonthMatch[2].padStart(2, '0');
                        part = `${year}-${month}`;
                        parts[i] = part;
                        corrected = parts.join(',');
                        wasFixed = true;
                    } else {
                        isValid = false;
                        error = `开学时间'${part}'格式错误，应为YYYY-MM格式`;
                        break;
                    }
                }

                const match = part.match(/^(\d{4})-(\d{2})$/);
                if (!match) {
                    isValid = false;
                    error = `开学时间'${part}'格式错误，应为YYYY-MM格式`;
                    break;
                }

                const year = parseInt(match[1]);
                const month = parseInt(match[2]);

                if (year < 1980 || year > 2100) {
                    isValid = false;
                    error = `开学时间年份'${year}'超出有效范围(1980-2100)`;
                    break;
                }

                if (month < 1 || month > 12) {
                    isValid = false;
                    error = `开学时间'${part}'月份无效，应为01-12`;
                    break;
                }
            }

            return { corrected, isValid, error, wasFixed };
        }

    </script>
</body>
</html>